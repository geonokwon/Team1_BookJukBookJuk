<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>북적북적</title>
  
  <!-- 구글폰트 -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- 사이드바 아이콘 -->

  <link th:href="@{/images/common/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
  <link th:href="@{/images/common/remixicon/remixicon.css}" rel="stylesheet">

  
  <!--부트스트랩 외부링크-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Main CSS File -->


  <link th:href="@{/css/common/style.css}" rel="stylesheet">
  <link th:href="@{/css/rent/rent.css}" rel="stylesheet">


</head>

<body>
	
	<div th:replace="~{/fragment/header :: header2}"></div>
	<div th:replace="~{/fragment/sidebar :: sidebar2}"></div>
	
	<main id="main" class="main">
	
	<div class="container rent">
	<!-- 도서 대여 관리 폼 시작 -->
	  <div class="container my-5">
		
			  <!-- 도서 대여 관리 모달 시작 -->
			        <div class="modal fade" id="rentalModal" tabindex="-1" aria-labelledby="rentalModalLabel" aria-hidden="true">
			          <div class="modal-dialog modal-lg">
			            <div class="modal-content">
			              <div class="modal-header">
			                <h5 class="modal-title" id="rentalModalLabel">도서 대여 관리</h5>
			                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			              </div>
			              <div class="modal-body">
			                <form class="rental-form" id="rentalForm">
								<div class="form-group">
								            <label for="memberId">회원 아이디</label>
								            <div class="input-group">
								                <input type="text" id="memberId" class="form-control" placeholder="회원 아이디 입력">
								                <button type="button" class="btn btn-secondary" onclick="openMemberSearchPopup()">회원검색</button>
								            </div>
								        </div>
								        
								        <div class="form-group">
								            <label for="bookName">책 이름</label>
								            <div class="input-group">
								                <input type="text" id="bookName" class="form-control" placeholder="책 이름 입력">
								                <button type="button" class="btn btn-secondary" onclick="openBookSearchPopup()">책 검색</button>
								            </div>
								        </div>

								        <!-- 나머지 폼 요소는 변경하지 않고 그대로 둡니다. -->
								        <div class="form-group">
								            <label for="memberName">회원 이름</label>
								            <input type="text" id="memberName" class="form-control" placeholder="회원 이름 입력">
								        </div>
								        
								        <div class="form-group">
								            <label for="bookId">책 번호</label>
								            <input type="text" id="bookId" class="form-control" placeholder="책 번호 입력">
								        </div>

								        <div class="form-group">
								            <label for="contact">연락처</label>
								            <input type="text" id="contact" class="form-control" placeholder="연락처 입력">
								        </div>
								        
								        <div class="form-group">
								            <label for="rentalDate">대여일</label>
								            <input type="date" id="rentalDate" class="form-control">
								        </div>

								        <div class="d-flex justify-content-start gap-2">
								            <button type="submit" class="btn btn-success">대여 등록</button>
								            <button type="reset" class="btn btn-danger">초기화</button>
								        </div>
			                </form>
			              </div>
			            </div>
			          </div>
			        </div>
			        <!-- 도서 대여 관리 모달 끝 -->
						
				<select>
					<option value="대여중">회원 이름</option>
					<option value="연체중">회원 아이디</option>
					<option value="반납완료">책 이름</option>
					<option value="반납완료">책 번호</option>
					<option value="반납완료">지점</option>
				</select>
				<input type="text">
				<button type="submit" class="btn btn-success">검색</button>
				<button type="reset" class="btn btn-danger">초기화</button>
				
				<!-- 도서 대여 관리 모달 열기 버튼 -->
						      <button type="button" class="btn btn-primary my-5" data-bs-toggle="modal" data-bs-target="#rentalModal">
						        도서 대여 등록
						      </button>
				
		<table class="rental-table">
		    <thead>
		        <tr>
		            <th>대여 번호</th>
		            <th>회원 번호</th>
		            <th>회원 ID</th>
		            <th>회원 이름</th>
		            <th>회원 전화번호</th>
		            <th>도서 번호</th>
		            <th>도서 이름</th>
		            <th>대여일</th>
		            <th>반납일</th>
		            <th>반납 여부</th>
		        </tr>
		    </thead>
		    <tbody>
		        <tr th:each="rent : ${rentList}">
		            <td th:text="${rent.rentNum}"></td>
		            <td th:text="${rent.userNum}"></td>
		            <td th:text="${rent.userId}"></td>
		            <td th:text="${rent.userName}"></td>
		            <td th:text="${rent.userPhone}"></td>
		            <td th:text="${rent.bookNum}"></td>
		            <td th:text="${rent.bookName}"></td>
		            <td th:text="${#dates.format(rent.rentDate, 'yyyy-MM-dd')}"></td>
		            <td th:text="${#dates.format(rent.returnDate, 'yyyy-MM-dd')}"></td>
					<td>
						<select th:onchange="updateReturnInfo(this, [[${rent.rentNum}]])">
							<option value="대여중" th:selected="${rent.returnInfo == '대여중'}">대여중</option>
							<option value="연체중" th:selected="${rent.returnInfo == '연체중'}">연체중</option>
							<option value="반납완료" th:selected="${rent.returnInfo == '반납완료'}">반납완료</option>
						</select>
					</td>
		        </tr>
		    </tbody>
		</table>
		
		<!--		페이징 처리-->
				<div>
		<!--			이전-->
		      <a th:href="@{/rent(page=${currentPage-1})}" 
			     th:if="${currentPage > 1}" th:text="이전"> </a>
				 
		<!--		숫자 부분-->
				<span th:each="page:${#numbers.sequence(startPage,endPage)}">
					<span th:if="${page == currentPage}" th:text="${page}"> </span>
					<span th:unless="${page == currentPage}">
						<a th:href="@{/rent(page=${page})}" th:text="${page}"> </a>
					</span>
				</span>
				
		<!--		다음-->
				<a th:href="@{/rent(page=${currentPage+1})}" 
			     th:if="${currentPage < totalPages}" th:text="다음"> </a>
				</div>
		
		</div>
    </div>
	</main>
<!-- 사이드바 열었다 닫았다 하는거 -->
	<script th:src="@{/js/common/main.js}"></script>
	
<!--	멤버 검색 팝업-->
	<script>
          function openMemberSearchPopup() {
              window.open(
                  'membersearch',  // 팝업에 표시할 페이지를 별도로 생성
                  '회원 검색',            // 팝업 창 이름
                  'width=600,height=400,scrollbars=yes' // 창 크기와 옵션 설정
              );
          }
      </script>
	  
<!--	  책 검색 팝업-->
	<script>
		function openBookSearchPopup() {
			window.open(
				'booksearch',  // 팝업에 표시할 페이지를 별도로 생성
				'책 검색',            // 팝업 창 이름
				'width=600,height=400,scrollbars=yes' // 창 크기와 옵션 설정
			);
		}
	</script>
  
	<script>
		// 현재 날짜 가져오기 및 초기화 버튼 클릭 시 현재 날짜 설정
		const today = new Date().toISOString().split('T')[0];
		const rentalDateInput = document.getElementById('rentalDate');
		rentalDateInput.value = today;

		// 초기화 버튼 눌렀을 때, 대여일 다시 현재 날짜로 설정
		document.getElementById('rentalForm').addEventListener('reset', function() {
			setTimeout(function() {
			rentalDateInput.value = today;
		}, 0); // 초기화 후 바로 오늘 날짜로 세팅
	});
	</script>
	
<!--	드랍박스 선택시 자동 db적용-->
	<script>
		function updateReturnInfo(selectElement, rentNum) {
		    const returnInfo = selectElement.value;

		    fetch(`/updateReturnInfo`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify({
		            rentNum: rentNum,
		            returnInfo: returnInfo
		        }),
		    })
		    .then(response => {
		        if (response.ok) {
		            alert("반납 상태가 성공적으로 업데이트되었습니다.");
		            location.reload(); // 페이지 새로고침
		        } else {
		            alert("업데이트 중 오류가 발생했습니다.");
		            location.reload(); // 오류 발생 시에도 페이지 새로고침
		        }
		    })
		    .catch(error => {
		        console.error("에러:", error);
		        location.reload(); // 네트워크 오류 발생 시에도 새로고침
		    });
		}


	</script>
  
</body>

</html>