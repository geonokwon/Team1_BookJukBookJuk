<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>북적북적::알림 메시지 관리</title>
  
  <!-- 구글폰트 -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  
  <!-- 사이드바 아이콘 -->
  <link href="/images/common/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="/images/common/remixicon/remixicon.css" rel="stylesheet">
  
  <!--부트스트랩 외부링크-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Main CSS File -->
  <link href="/css/event/style.css" rel="stylesheet">
  <link href="/css/common/style.css" rel="stylesheet">
    
  <!--  DataTables-->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css">
</head>
<body class="noti-body">
	<div th:replace="/fragment/header :: header2"></div>
	<div th:replace="/fragment/sidebar :: sidebar2"></div>
	<div class="container my-4">
	    <h2>알림 메시지 관리</h2>
		<div>
		  <!-- Show Entries and Filter Button -->
		  <button id="filterButton">필터</button>
		  <div id="selectedFilters"></div>
		</div>

		<!-- Filter Modal -->
		<div id="filterModal" class="modal">
		  <div class="modal-content">
		    <span class="close">&times;</span>
		    
		    <h3>필터 설정</h3>
		    
		    <!-- 알림 유형 -->
		    <label>알림 유형</label>
		    <div>
		      <input type="radio" name="alertType" value="sms"> SMS
		      <input type="radio" name="alertType" value="note"> 쪽지
		      <input type="radio" name="alertType" value="" checked> 선택 안 함
		    </div>
		    
		    <!-- 전송 상태 -->
		    <label>전송 상태</label>
		    <div>
		      <input type="checkbox" name="status" value="대기"> 대기
		      <input type="checkbox" name="status" value="성공"> 성공
		      <input type="checkbox" name="status" value="실패"> 실패
		    </div>
		    
		    <!-- 전송 날짜 -->
		    <label>전송 날짜</label>
		    <div>
		      <input type="date" id="startDate" value="2024-10-24">
		      <span> ~ </span>
		      <input type="date" id="endDate" value="2024-10-24">
		    </div>
		    
		    <button id="applyFilter">완료</button>
		  </div>
		</div>

    <table id="marketingTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>No.</th>
                <th>수신인</th>
                <th>알림 내용</th>
                <th>알림 유형</th>
                <th>전송 상태</th>
                <th>전송 날짜</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>6</td>
                <td>kim123</td>
                <td>vdffffffffgㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇㅇ</td>
                <td>쪽지</td>
                <td>성공</td>
                <td>2024-10-08 16:10:07</td>
            </tr>
            <tr>
                <td>5</td>
                <td>park456</td>
                <td>b gb gggh</td>
                <td>sms</td>
                <td>성공</td>
                <td>2024-10-17 04:08:00</td>
            </tr>
            <!-- 추가 행들... -->
        </tbody>
    </table>
</div>

<!-- jQuery and DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 사이드바 열었다 닫았다 하는거 -->
<script src="/js/common/main.js"></script>

<script>
    $(document).ready(function() {
        const table = $('#marketingTable').DataTable({
            paging: true,
            searching: true,
            info: false,
            language: {
                search: "검색: ",
                paginate: {
                    previous: "이전",
                    next: "다음"
                }
            },
			dom: '<"d-flex justify-content-between align-items-center"l<"d-flex align-items-center"f>>rt<"d-flex justify-content-center"p><"d-flex justify-content-between"i>',
        });

        // 검색 상단에 드롭다운 메뉴 추가
		$(".dataTables_filter").append(`
		    <select id="columnSelect" class="form-select ms-2" style="width: auto; display: inline;">
		        <option value="">전체</option>
		        <option value="0">NO</option>
		        <option value="1">담당자</option>
		        <option value="2">전송유형</option>
		        <option value="3">전송내용</option>
		        <option value="4">수신번호</option>
		        <option value="5">전송날짜</option>
		    </select>
		`);

        // 검색 이벤트 설정
        $('#marketingTable_filter input').off().on('keyup', function() {
            const column = $('#columnSelect').val();
            const searchValue = $(this).val();
            if (column) {
                table.column(column).search(searchValue).draw();
            } else {
                table.search(searchValue).draw();
            }
        });
    });
</script>

<script>
	$(document).ready(function () {
	  // Initialize DataTable
	  const table = $('#marketingTable').DataTable();

	  // Custom Filter Variables
	  let alertType = '';
	  let status = [];
	  let startDate = '';
	  let endDate = '';

	  // Custom Filter Function
	  $.fn.dataTable.ext.search.push(function (settings, data) {
	    const rowAlertType = data[0]; // 알림 유형
	    const rowStatus = data[1]; // 전송 상태
	    const rowDate = data[2]; // 전송 날짜

	    // 알림 유형 필터링
	    if (alertType && rowAlertType !== alertType) return false;

	    // 전송 상태 필터링
	    if (status.length && !status.includes(rowStatus)) return false;

	    // 전송 날짜 필터링
	    if (startDate || endDate) {
	      const date = new Date(rowDate);
	      if (startDate && date < new Date(startDate)) return false;
	      if (endDate && date > new Date(endDate)) return false;
	    }

	    return true;
	  });

	  // Open Filter Modal
	  $('#filterButton').click(() => {
	    $('#filterModal').css('display', 'block');
	  });

	  // Close Filter Modal
	  $('.close').click(() => {
	    $('#filterModal').css('display', 'none');
	  });

	  // Apply Filter
	  $('#applyFilter').click(() => {
	    // Get selected filters
	    alertType = $('input[name="alertType"]:checked').val();
	    status = $('input[name="status"]:checked').map((_, el) => el.value).get();
	    startDate = $('#startDate').val();
	    endDate = $('#endDate').val();

	    // Display applied filters
	    displayAppliedFilters();

	    // Re-draw DataTable with new filters
	    table.draw();

	    // Close modal
	    $('#filterModal').css('display', 'none');
	  });

	  // Display Selected Filters with Remove Option
	  function displayAppliedFilters() {
	    $('#selectedFilters').empty();

	    if (alertType) addFilterChip(`알림 유형: ${alertType}`, 'alertType');
	    status.forEach(st => addFilterChip(`전송 상태: ${st}`, 'status'));
	    if (startDate && endDate) addFilterChip(`${startDate} ~ ${endDate}`, 'date');
	  }

	  function addFilterChip(text, type) {
	    const chip = $('<div class="filter-chip"></div>').text(text);
	    const closeBtn = $('<span>x</span>').click(() => removeFilter(type, text));

	    chip.append(closeBtn);
	    $('#selectedFilters').append(chip);
	  }

	  // Remove Filter and Re-apply
	  function removeFilter(type, text) {
	    if (type === 'alertType') alertType = '';
	    else if (type === 'status') status = status.filter(st => `전송 상태: ${st}` !== text);
	    else if (type === 'date') { startDate = ''; endDate = ''; }

	    displayAppliedFilters();
	    table.draw();
	  }
	});

</script>
</body>
</html>
